name: 'Update examples'

on:
  push:
    tags: [ '*' ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag'
        required: true

defaults:
  run:
    shell: bash

jobs:

  update-examples:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: pip install -r .github/scripts/requirements.txt
      - run: echo "NEW_VERSION=${{ inputs.ref || github.ref_name }}" >> $GITHUB_ENV
      - name: 'Get versions'
        run: |
          # Delete latest for sorting. v:refname doesn't handle Maven version qualifiers correctly.
          git tag -d "$NEW_VERSION"
          old_version="$(git tag --sort=-v:refname | head -n 1)"
          echo "OLD_VERSION=$old_version" >> $GITHUB_ENV
      - name: 'Update version in all files'
        run: ./.github/scripts/replace_string.py ./ "$OLD_VERSION" "$NEW_VERSION"
      - name: 'Create PR'
        uses: peter-evans/create-pull-request@v7
        with:
          base: 'main'
          branch: "replace-${{ env.OLD_VERSION }}-${{ env.NEW_VERSION }}"
          title: "Update version in examples to ${{ env.NEW_VERSION }}"
          author: "github-actions <github-actions@github.com>"
          committer: "github-actions <github-actions@github.com>"
